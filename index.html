<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <script type="module">
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    //const canvasElementOver = document.getElementsByClassName('output_canvas_over')[0];
    const canvasCtx = canvasElement.getContext('2d');
    let x, x_thumb, x_POINTER, x_middle, x_ring, x_pinky = null;
    let y, y_thumb, y_POINTER, y_middle, y_ring, y_pinky = null;
    //buffer
    let margin = 0.05
    let last_x_thumb = 0;
    let thumb_play = 0;
    let last_x_POINTER = 0;
    let POINTER_play = 0;
    console.log(last_x_thumb);



    let midiOutput = null;
    const NOTE_ON = 0x90;
    const NOTE_OFF = 0x80;
    const CONTROL_CHANGE= 0xB0;

    const NOTE_DURATION = 300;


    const playNote = function (notes,thumbsPositionFilter) {
      midiOutput.send([NOTE_ON, notes, 0x7f]);
      midiOutput.send([NOTE_OFF, notes, 0x7f], window.performance.now() + 1000.0);
      midiOutput.send([CONTROL_CHANGE,thumbsPositionFilter,0x7f]);
    }

    navigator.requestMIDIAccess()
      .then(function (midiAccess) {
        const outputs = midiAccess.outputs.values();
        console.log(outputs);
        for (const output of outputs) {
          console.log(output);
          midiOutput = output;
        }

      });


    function range(input) {

      if ((input * 105.83) > 127) {
        return 127;

      } else {
        return input * 105.83
      }

    }
    function drawPointer(x, y) {
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.beginPath();
      ctx.lineWidth = "6";
      ctx.strokeStyle = "red";
      ctx.arc(x, y, 50, 0, 2 * Math.PI);
      //ctx.rect(x, y, 400, 400);
      ctx.stroke();
    }

    function onResults(results) {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(
        results.image, 0, 0, canvasElement.width, canvasElement.height);
      if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {




          x_thumb = results.multiHandLandmarks[0][4].x;
          y_thumb = results.multiHandLandmarks[0][4].y;



          //  console.log(x_thumb +'--'+last_x_thumb );


          if ((x_thumb > (last_x_thumb + margin)) || (x_thumb < (last_x_thumb - margin)) || last_x_thumb === 0) {
            last_x_thumb = x_thumb;
            //console.log(last_x_thumb);
            thumb_play = 1
          }



          x_POINTER = results.multiHandLandmarks[0][8].x;
          y_POINTER = results.multiHandLandmarks[0][8].y;


          if ((x_POINTER > last_x_POINTER + margin) || (x_POINTER < last_x_POINTER - margin) || last_x_POINTER === 0) {
            last_x_POINTER = x_POINTER;
            //console.log(last_x_POINTER);
            POINTER_play = 1;

          }



          /**Play Chenged NOtes **/


          if (thumb_play === 1) {
            thumb_play = 0
            //console.log(' thumb');
            //playNote(Math.ceil(range(last_x_thumb)));
          }
          if (POINTER_play === 1) {
            //console.log(' pointer');
            POINTER_play = 0;
            playNote(Math.ceil(range(last_x_POINTER)),Math.ceil(range(last_x_thumb)));
          }


          //drawPointer(last_x_thumb * 1280, y_thumb * 720);
          drawPointer(last_x_POINTER * 1280, y_POINTER * 720);



          x_middle = results.multiHandLandmarks[0][12].x;
          y_middle = results.multiHandLandmarks[0][12].y;


          x_ring = results.multiHandLandmarks[0][16].x;
          y_ring = results.multiHandLandmarks[0][16].y;










          setTimeout(function () {
            //drawPointer(x_thumb * 1280, y_thumb * 720);
            drawPointer(x_POINTER * 1280, y_POINTER * 720);

          }, 300);
          //drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 5 });
          //drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 2 });
        }
      }
      canvasCtx.restore();
    }

    const hands = new Hands({
      locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
      }
    });
    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 1,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({ image: videoElement });
      },
      width: 1280,
      height: 720
    });
    camera.start();
  </script>
</head>

<body>
  <div class="container">
    <video class="input_video"></video>
    <canvas id='myCanvas' class="output_canvas" width="1280px" height="720px"></canvas>
    <!-- <canvas id='myCanvasOver' class="output_canvas_over" width="1280px" height="720px"></canvas> -->
  </div>
</body>

</html>